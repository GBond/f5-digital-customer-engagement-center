<!DOCTYPE html>
<div id="clouddocs-header">
  <div class="container-fluid">
    <div class="row corp-header">
      <div class="container corp-header">
        <div class="container corp-menu">
          <ul>
            <li><a href="https://f5.com" class="internalLink">F5.com</a></li>
            <li><a href="https://github.com/F5Networks" class="externalLink">GitHub</a></li>
            <li><a href="https://devcentral.f5.com" class="internalLink">Devcentral</a></li>
            <li><a href="https://support.f5.com" class="internalLink">Support</a></li>
          </ul>
        </div>
      </div>
    </div>

    <script async="async"
      src="https://consent.trustarc.com/notice?domain=f5.com&amp;c=teconsent&amp;text=true&amp;gtm=1" crossorigin=""
      id="truste_0.12182038258598205"></script>

    <div class="row pageHeader">
      <div class="container stat">
        <div class="col-xs-12 stat">
          <a class="internalLink" href="https://f5.com">
            <img class="logo" src="https://cdn.f5.com/websites/support/assets/images/logo.svg" width="50" height="44"
              alt="F5 Networks" title="F5 Networks" border="0">
          </a>
          <ul id="MainMenu" class="main-menu">
            <li data-submenu-id="products">
              <a data-link-type="nav: main" href="#" class="currentURL">Products
                <span class="indicator"><span class="arrow-up"></span></span>
              </a>
              <div class="menu-panel soft-hide" id="products-submenu">
                <div class="container">
                  <ul class="submenu">
                    <li>
                      <span class="a-mm-h">BIG-IP Extensibility</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/products/extensions/f5-appsvcs-extension/latest" data-link-type="Nav: Mega">F5
                            Application Services Extension 3</a></li>
                        <li><a href="https://clouddocs.f5.com/products/agc/latest" data-link-type="Nav: Mega">BIG-IP APM Access Guided
                            Configuration</a></li>
                        <li><a href="https://clouddocs.f5.com/products/iapp/iapp-lx/latest" data-link-type="Nav: Mega">iApps LX/iControl LX</a>
                        </li>
                        <li><a href="https://clouddocs.f5.com/products/extensions/f5-declarative-onboarding/latest"
                            data-link-type="Nav: Mega">F5 Declarative Onboarding</a></li>
                        <li><a href="https://clouddocs.f5.com/products/extensions/f5-telemetry-streaming/latest" data-link-type="Nav: Mega">F5
                            Telemetry Streaming</a></li>
                        <li><a href="https://clouddocs.f5.com/products/extensions/f5-cloud-failover/latest" data-link-type="Nav: Mega">F5 Cloud
                            Failover</a></li>
                        <li><a href="https://clouddocs.f5.com/products/extensions/f5-appsvcs-templates/latest/" data-link-type="Nav: Mega">F5
                            Application Services Templates</a></li>
                      </ul>
                    </li>


                    <li class="divider"></li>
                    <li><span class="a-mm-h">Container Ingress Services</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/containers/latest/" data-link-type="Nav: Mega">F5 BIG-IP Controller for
                            Kubernetes/OpenShift</a></li>
                      </ul>
                      <span class="a-mm-h">Network Function Virtualization</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/cloud/nfv/latest" data-link-type="Nav: Mega">F5 VNF Manager</a></li>
                      </ul>
                      <span class="a-mm-h">SDK</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/sdk/f5-cli" target="_blank">F5 CLI</a></li>
                        <li><a href="https://clouddocs.f5.com/sdk/f5-sdk-python" target="_blank">F5 SDK Python</a></li>
                      </ul>
                    </li>



                    <li class="divider"></li>
                    <li>
                      <span class="a-mm-h">OpenStack</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/products/openstack/agent/latest" data-link-type="Nav: Mega">F5 Agent - OpenStack
                            Neutron</a></li>
                        <li><a href="https://clouddocs.f5.com/products/openstack/lbaasv2-driver/latest" data-link-type="Nav: Mega">F5 Driver -
                            OpenStack LBaaS</a></li>
                        <li><a href="https://clouddocs.f5.com/products/openstack/heat-plugins/latest" data-link-type="Nav: Mega">F5 Plugins -
                            OpenStack Heat</a></li>
                      </ul>

                      <span class="a-mm-h">Ecosystems Integrations</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/f5-aci-servicecenter/latest" data-link-type="Nav: Mega">F5 ACI ServiceCenter</a>
                        </li>
                      </ul>


                    </li>
                    <li class="divider"></li>
                    <li><span class="a-mm-h">Orchestration</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/products/orchestration/ansible/devel" target="_blank">F5 Modules for Ansible</a>
                        </li>
                        <li><a href="https://github.com/F5Networks/f5-aws-cloudformation" target="_blank"
                            class="externalLink">F5 Templates for AWS CloudFormation</a> (GitHub)</li>
                        <li><a href="https://github.com/F5Networks/f5-azure-arm-templates" target="_blank"
                            class="externalLink">F5 Templates for Azure ARM</a> (GitHub)</li>
                        <li><a href="https://github.com/F5Networks/f5-google-gdm-templates" target="_blank"
                            class="externalLink">F5 Templates for Google Cloud Deployment Manager</a> (GitHub)</li>
                        <li><a href="https://clouddocs.f5.com/products/templates/openstack-heat/latest" data-link-type="Nav: Mega">F5 Templates
                            for OpenStack Heat</a></li>
                        <li><a href="https://clouddocs.f5.com/products/orchestration/terraform/latest/" data-link-type="Nav: Mega">F5 Resources
                            for Terraform Provider</a></li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </li>

            <!--- NEW -->
            <li>
              <a href="#" class="currentURL">APIs
                <span class="indicator"><span class="arrow-up"></span></span>
              </a>

              <div class="menu-panel soft-hide" id="APISubmenu">
                <div class="container">
                  <ul class="submenu">
                    <li>
                      <span class="a-mm-h"></span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/products/big-iq/mgmt-api/latest/" data-link-type="Nav: Mega">F5 BIG-IQ API</a>
                        </li>
                        <li><a href="https://clouddocs.f5.com/api/iapps/">F5 BIG-IP iApps</a></li>
                        <li><a href="https://clouddocs.f5.com/api/irules">F5 BIG-IP iRules API</a></li>
                        <li><a href="https://clouddocs.f5.com/api/irules-lx">F5 BIG-IP iRulesLX API</a></li>
                      </ul>
                    </li>

                    <li class="divider"></li>

                    <li>
                      <span class="a-mm-h"></span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/api/icontrol-rest">F5 BIG-IP iControlREST API</a></li>
                        <li><a href="https://clouddocs.f5.com/api/icontrol-soap/">F5 BIG-IP iControl API</a></li>
                        <li><a href="https://clouddocs.f5.com/api/ihealth/">F5 iHealth API</a></li>
                        <li><a href="https://clouddocs.f5.com/api/tmsh">F5 tmsh scripting API</a></li>
                      </ul>
                    </li>

                  </ul>
                </div>
              </div>
            </li>




            <li>
              <a href="#" class="currentURL">Cloud &amp; Container
                <span class="indicator"><span class="arrow-up"></span></span>
              </a>

              <div class="menu-panel soft-hide" id="ContainersSubmenu">
                <div class="container">
                  <ul class="submenu col-sm-11">
                    <li class="third"><span class="a-mm-h">Cloud Services</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/cloud-services/latest/f5-cloud-services-GS-About.html"
                            data-link-type="Nav: Mega">Get Started</a></li>
                        <li><a href="https://clouddocs.f5.com/cloud-services/latest/f5-cloud-services-Beacon-About.html"
                            data-link-type="Nav: Mega">Beacon</a></li>
                        <li><a href="https://clouddocs.f5.com/cloud-services/latest/f5-cloud-services-DNS-About.html"
                            data-link-type="Nav: Mega">DNS Cloud Service</a></li>
                        <li><a href="https://clouddocs.f5.com/cloud-services/latest/f5-cloud-services-GSLB-About.html"
                            data-link-type="Nav: Mega">DNS Load Balancer Cloud Service</a></li>
                        <li><a href="https://clouddocs.f5.com/cloud-services/latest/f5-cloud-services-Essential.App.Protect-About.html"
                            data-link-type="Nav: Mega">Essential App Protect Service</a></li>
                      </ul>
                    </li>
                    <li class="divider"></li>
                    <li class="third"><span class="a-mm-h">Clouds</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/cloud/public/v1/aws_index.html" data-link-type="Nav: Mega">AWS</a></li>
                        <li><a href="https://clouddocs.f5.com/cloud/public/v1/azure_index.html" data-link-type="Nav: Mega">Azure</a></li>
                        <li><a href="https://clouddocs.f5.com/cloud/public/v1/google_index.html" data-link-type="Nav: Mega">Google Cloud</a>
                        </li>
                        <li><a href="https://clouddocs.f5.com/cloud/openstack/" data-link-type="Nav: Mega">OpenStack</a></li>
                      </ul>
                      <!-- unnecessary right now>
                    <span class="seemore"><a data-link-type="Nav: Mega" href="/cloud/">See all </a></span>
                    <-->
                    </li>
                    <li class="divider"></li>
                    <li class="third"><span class="a-mm-h">Containers</span>
                      <ul>
                        <li><a href="https://clouddocs.f5.com/containers/latest/userguide/kubernetes/" data-link-type="Nav: Mega">Kubernetes</a>
                        </li>
                        <li><a href="https://clouddocs.f5.com/containers/latest/userguide/openshift/" data-link-type="Nav: Mega">OpenShift</a>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </li>
            <li>
              <a href="#" class="currentURL">Resources
                <span class="indicator"><span class="arrow-up"></span></span>
              </a>
              <div class="menu-panel soft-hide" id="UPCProgramSubmenu">
                <div class="container">
                  <ul class="submenu col-sm-11">
                    <li class="third">
                      <span class="a-mm-h">Downloads</span>
                      <ul>
                        <li><a target="_blank" data-link-type="Nav: Mega" href="https://hub.docker.com/r/f5networks/"
                            class="internalLink externalLink">Docker Hub</a></li>
                        <li><a target="_blank" data-link-type="Nav: Mega"
                            href="https://store.docker.com/images/f5networks-asp"
                            class="internalLink externalLink">Docker Store</a></li>
                      </ul>
                      <span class="a-mm-h">OpenSource</span>
                      <ul>
                        <li><a target="_blank" data-link-type="Nav: Mega" href="https://github.com/F5Networks"
                            class="internalLink externalLink">F5Networks on GitHub</a></li>
                        <li><a target="_blank" data-link-type="Nav: Mega" href="https://github.com/F5DevCentral"
                            class="internalLink externalLink">F5DevCentral on GitHub</a></li>
                      </ul>
                    </li>
                    <li class="divider"></li>
                    <li class="third">
                      <span class="a-mm-h">Training &amp; Labs</span>
                      <ul>
                        <li>
                          <p>Learn how to get the most out of the F5 platform</p>
                        </li>
                        <li><a href="https://clouddocs.f5.com/training/community">Community</a></li>
                      </ul>
                    </li>
                    <li class="divider"></li>

                    <li class="third">
                      <a href="//university.f5.com" class="a-mm-h internalLink" target="_blank"
                        data-link-type="Nav: Mega">F5 University</a>
                      <ul>
                        <li>
                          <p>Get up to speed with free self-paced courses</p>
                        </li>
                      </ul>
                      <a data-ng-href="https://devcentral.f5.com" class="a-mm-h internalLink" target="_blank"
                        data-link-type="Nav: Mega" href="https://devcentral.f5.com">DevCentral</a>
                      <ul>
                        <li>
                          <p>Join the community of 250,000+ technical peers</p>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </li>
          </ul>
        </div>

        <div class="col-xs-12 stat">
          <div class="topLinks">
            <span class="glyphicon glyphicon-search upc-search" id="search-toggle" style="display: none;"></span>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- /container-fluid -->
</div>
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nginx - Kubernetes Ingress Controller with Application Protect &#8212; F5 Digital Customer Engagement Center 0.1 documentation</title>
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Telemetry" href="../../../../telemetry/telemetry.html" />
    <link rel="prev" title="Security" href="../../../security.html" />

  
    

  
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="dismiss">
      <button type="button" class="btn btn-info navbar-btn site-hidden">
        <i class="fa fa-align-justify"></i>
      </button>
    </div>
    <div id="sidebar" class="section-nav">
      
      <nav class="nav-sidebartoc">

        
        <h5>F5 Digital Customer Engagement Center 0.1 </h5>
        
<div id="searchbox" role="search">
  <form class="search" action="../../../../../search.html" method="get">
    <input type="text" class="search" name="q" placeholder=" Search..." />
    <button type="submit" class="btn btn-info navbar-btn"><i class="fa fa-search"></i></button>
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        <hr>
        <h5>Current Page</h5>
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Nginx - Kubernetes Ingress Controller with Application Protect</a></li>
</ul>

         </span>
        <hr>
        <h5>Site Contents</h5>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../intro/intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../delivery/delivery.html">Delivery</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../security.html">Security</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Nginx - Kubernetes Ingress Controller with Application Protect</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../telemetry/telemetry.html">Telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributions/contributions.html">Contributions</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>

  
  <div class="main active" id="content">
    <article class="docs-container site-article-inner">
            <nav class="site-breadcrumb-nav site-nav">
          <ul class="site-breadcrumb-list">
            <li class="breadcrumb-item"><button type="button" id="sidebarCollapse" class="btn btn-info navbar-btn site-hidden"><i class="fa fa-align-justify"></i></button>&#x20 <a href="/">CloudDocs Home</a> &gt; <a href="../../../../../index.html">F5 Digital Customer Engagement Center </a> &gt; Nginx - Kubernetes Ingress Controller with Application Protect</li>
          </ul>
      </nav>
      

    
  <div class="section" id="nginx-kubernetes-ingress-controller-with-application-protect">
<h1>Nginx - Kubernetes Ingress Controller with Application Protect<a class="headerlink" href="#nginx-kubernetes-ingress-controller-with-application-protect" title="Permalink to this headline">¶</a></h1>
<p>In this workshop, we will implement a per-pod Web Application Firewall. The Nginx WAF will allow to improve the application security posture, especially against <a class="reference external" href="https://owasp.org/www-project-top-ten/">OWASP Top 10 attacks</a>.</p>
<p>In our scenario, since we decided our Nginx WAF to be enabled on a per-pod basis, we will be able to protect all the traffic coming into the pod regardless of where it is originating from (external or internal to the Kubernetes cluster).</p>
<p>We’ll be able to bring security closer to the application and the development cycle and integrate it into CI/CD pipelines. This will allow to minimize false positives, since the WAF policy becomes a part of the application and is always tested as such.</p>
<ol class="arabic simple">
<li><p>Create the Nginx WAF config, which can be found in the
“files/7waf/waf-config.yaml” file.</p></li>
</ol>
<pre>
Command:
kubectl apply -f files/7waf/waf-config.yaml
</pre><p>The WAF policy is json based and from the example bellow, you can
observe how all the configuration can be changed based on the
application needs:</p>
<pre>
    {
      "name": "nginx-policy",
      "template": { "name": "POLICY_TEMPLATE_NGINX_BASE" },
      "applicationLanguage": "utf-8",
      "enforcementMode": "blocking",
      "signature-sets": [
      {
          "name": "All Signatures",
          "block": false,
          "alarm": true
      },
      {
          "name": "High Accuracy Signatures",
          "block": true,
          "alarm": true
      }
    ],
      "blocking-settings": {
      "violations": [
          {
              "name": "VIOL_RATING_NEED_EXAMINATION",
              "alarm": true,
              "block": true
          },
          {
              "name": "VIOL_HTTP_PROTOCOL",
              "alarm": true,
              "block": true,
              "learn": true
          },
          {
              "name": "VIOL_FILETYPE",
              "alarm": true,
              "block": true,
              "learn": true
          },
          {
              "name": "VIOL_COOKIE_MALFORMED",
              "alarm": true,
              "block": false,
              "learn": false
          }
      ],
          "http-protocols": [{
          "description": "Body in GET or HEAD requests",
          "enabled": true,
          "learn": true,
          "maxHeaders": 20,
          "maxParams": 500
      }],
          "filetypes": [
          {
              "name": "*",
              "type": "wildcard",
              "allowed": true,
              "responseCheck": true
          }
      ],
          "data-guard": {
          "enabled": true,
              "maskData": true,
              "creditCardNumbers": true,
              "usSocialSecurityNumbers": true
      },
      "cookies": [
          {
              "name": "*",
              "type": "wildcard",
              "accessibleOnlyThroughTheHttpProtocol": true,
              "attackSignaturesCheck": true,
              "insertSameSiteAttribute": "strict"
          }
      ],
          "evasions": [{
          "description": "%u decoding",
          "enabled": true,
          "learn": false,
          "maxDecodingPasses": 2
      }]}
    }
</pre><ol class="arabic simple" start="2">
<li><p>Deploy ELK in order to be able to visualize and analyze the traffic going through the Nginx WAF:</p></li>
</ol>
<pre>
Command:
kubectl apply -f files/7waf/elk.yaml
</pre><ol class="arabic simple" start="3">
<li><p>In order to connect to our ELK pod, we will need to find the public address of this service:</p></li>
</ol>
<pre>
Command:
kubectl get svc elk-web

Output:
NAME      TYPE           CLUSTER-IP      EXTERNAL-IP                                                                  PORT(S)                                        AGE
elk-web   LoadBalancer   172.20.179.34   a28bd2d8c94214ae0b512274daa06211-2103709514.eu-central-1.elb.amazonaws.com   5601:32471/TCP,9200:32589/TCP,5044:31876/TCP   16h
</pre><ol class="arabic simple" start="4">
<li><p>Verify that ELK is up and running by browsing to: <code class="docutils literal notranslate"><span class="pre">http://[ELK-EXTERNAL-IP]:5601/</span></code>.</p></li>
</ol>
<ol class="arabic" start="5">
<li><p>Next, we need to change our deployment configuration so it includes the Nginx WAF.</p>
<pre>
Commands:
kubectl apply -f files/7waf/arcadia-main.yaml
kubectl apply -f files/7waf/arcadia-app2.yaml
kubectl apply -f files/7waf/arcadia-app3.yaml
kubectl apply -f files/7waf/arcadia-backend.yaml
</pre></li>
</ol>
<p>All of our services are protected and monitored.</p>
<ol class="arabic simple" start="6">
<li><p>Browse again to the Arcadia web app and verify that it is still working.</p></li>
<li><p>Let’s simulate a Cross Site Scripting (XSS) attack, and make sure it’s blocked:</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">https://&lt;INGRESS-EXTERNAL-IP&gt;/trading/index.php?a=%3Cscript%3Ealert(%27xss%27)%3C/script%3E</span></code></p>
<p>Each of the blocked requests will generate a support ID, save it for later.</p>
<ol class="arabic simple" start="8">
<li><p>Browse to the ELK as before and click the “Discover” button:</p></li>
</ol>
<div class="figure align-default">
<img alt="../../../../../_images/kibana1.jpeg" src="../../../../../_images/kibana1.jpeg" />
</div>
<p>Here, you’ll see all the request logs, allowed and blocked, sent by the Nginx WAF to ELK.</p>
<p>Let’s look for the reason why our attack requests were blocked.</p>
<ol class="arabic simple" start="9">
<li><p>Add a filter with the support ID you have received as seen bellow:</p></li>
</ol>
<div class="figure align-default">
<img alt="../../../../../_images/kibana2.jpeg" src="../../../../../_images/kibana2.jpeg" />
</div>
<p>In the right side of the panel, you can see the full request log and the reason why it was blocked.</p>
<ol class="arabic simple" start="10">
<li><p>Continue and explore the visualization capabilities of Kibana and log information from Nginx WAF by looking into the next two sections bellow the “Discover” button (Visualize and Dashboard -&gt; Overview).</p></li>
</ol>
<div class="figure align-default">
<img alt="../../../../../_images/7env.jpeg" src="../../../../../_images/7env.jpeg" />
</div>
</div>


    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../../../../_static/js/bootstrap.min.js"></script>
  <script src="../../../../../_static/js/clouddocs.js"></script>
  </body>
</html>